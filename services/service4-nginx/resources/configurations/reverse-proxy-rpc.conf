# Reverse Proxy to Blockchain Node RPC
# Purpose: Proxy requests to blockchain node RPC endpoints through Nginx
#
# Usage:
# 1. Copy this file to persistent-data/conf.d/reverse-proxy-rpc.conf
# 2. Modify the proxy_pass URLs to match your node ports
# 3. If using SSL, combine with https-ssl.conf configuration
# 4. Test: docker compose exec nginx nginx -t
# 5. Reload: docker compose exec nginx nginx -s reload
#
# Access RPC at: http://localhost/rpc/ (or your configured path)

server {
    listen 80;
    listen [::]:80;
    server_name localhost;

    # MODIFY: Change this path to your desired RPC endpoint
    # Example: /rpc, /api/rpc, /blockchain/rpc, etc.
    location /rpc {
        # MODIFY: Change to your blockchain node RPC port
        # For mainnet (node0-infinite): localhost:26657
        # For testnet (node1-infinite-testnet): localhost:26667
        # For creative (node2-infinite-creative): localhost:26677
        # For QOM (node3-qom): Check the port in docker-compose.yml
        proxy_pass http://localhost:26657;
        
        # Required proxy headers
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # WebSocket support (for subscriptions)
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        
        # Timeouts
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
        
        # Buffer settings
        proxy_buffering off;
        proxy_request_buffering off;
    }
    
    # MODIFY: gRPC endpoint (optional, uncomment if needed)
    # location /grpc {
    #     # MODIFY: Change to your gRPC port (usually 9090)
    #     proxy_pass http://localhost:9090;
    #     
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     
    #     # gRPC specific settings
    #     grpc_pass grpc://localhost:9090;
    #     grpc_set_header Host $host;
    #     grpc_set_header X-Real-IP $remote_addr;
    # }
    
    # MODIFY: REST API endpoint (optional, uncomment if needed)
    # location /api {
    #     # MODIFY: Change to your REST API port (usually 1317)
    #     proxy_pass http://localhost:1317;
    #     
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    # }
    
    # MODIFY: JSON-RPC endpoint (optional, uncomment if needed)
    # location /jsonrpc {
    #     # MODIFY: Change to your JSON-RPC port (usually 8545)
    #     proxy_pass http://localhost:8545;
    #     
    #     proxy_set_header Host $host;
    #     proxy_set_header X-Real-IP $remote_addr;
    #     proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    #     proxy_set_header X-Forwarded-Proto $scheme;
    #     
    #     # WebSocket support for JSON-RPC
    #     proxy_http_version 1.1;
    #     proxy_set_header Upgrade $http_upgrade;
    #     proxy_set_header Connection "upgrade";
    # }
    
    # Error handling
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        root /usr/share/nginx/html;
    }
}

