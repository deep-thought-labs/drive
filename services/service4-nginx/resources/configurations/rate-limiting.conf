# Rate Limiting Configuration
# Purpose: Protect endpoints from abuse with rate limiting
#
# Usage:
# 1. Copy this file to persistent-data/conf.d/rate-limiting.conf
# 2. Modify the rate limits and zones as needed
# 3. Apply to specific locations in your server blocks
# 4. Test: docker compose exec nginx nginx -t
# 5. Reload: docker compose exec nginx nginx -s reload
#
# Note: This file defines rate limit zones. Include these zones in your server blocks.

# MODIFY: Define rate limit zones
# Format: limit_req_zone $variable zone=name:size rate=rate;
# 
# $binary_remote_addr = client IP address
# zone name = identifier for this zone
# size = shared memory size (1m = 1 megabyte, stores ~16,000 IPs)
# rate = requests per second (r/s) or per minute (r/m)

# General rate limiting: 10 requests per second per IP
limit_req_zone $binary_remote_addr zone=general:10m rate=10r/s;

# Strict rate limiting: 2 requests per second per IP (for sensitive endpoints)
limit_req_zone $binary_remote_addr zone=strict:10m rate=2r/s;

# API rate limiting: 20 requests per second per IP
limit_req_zone $binary_remote_addr zone=api:10m rate=20r/s;

# Burst configuration: allows burst of requests
limit_req_zone $binary_remote_addr zone=burst:10m rate=10r/s;

# Example server block with rate limiting
server {
    listen 80;
    listen [::]:80;
    server_name localhost;
    
    root /usr/share/nginx/html;
    index index.html;
    
    # MODIFY: Apply general rate limiting to all requests
    # Uncomment to enable:
    # limit_req zone=general burst=20 nodelay;
    
    # MODIFY: Apply rate limiting to specific paths
    location /api/ {
        # Apply API rate limiting
        limit_req zone=api burst=30 nodelay;
        
        # MODIFY: Custom error response when rate limit is exceeded
        limit_req_status 429;
        
        # Your proxy or content here
        # proxy_pass http://localhost:8080;
        # or
        # try_files $uri $uri/ =404;
    }
    
    # MODIFY: Strict rate limiting for sensitive endpoints
    location /admin/ {
        # Apply strict rate limiting
        limit_req zone=strict burst=5 nodelay;
        
        # Your admin content here
        try_files $uri $uri/ =404;
    }
    
    # MODIFY: Burst configuration example
    # Allows 10 req/s normally, but can burst up to 30 requests
    location /downloads/ {
        limit_req zone=burst burst=30 nodelay;
        
        # Your downloads configuration here
        alias /usr/share/nginx/html/downloads;
    }
    
    # MODIFY: Whitelist specific IPs (optional)
    # Uncomment and modify IP addresses
    # geo $limit {
    #     default 1;
    #     192.168.1.0/24 0;  # Local network
    #     10.0.0.0/8 0;       # Private network
    # }
    # 
    # map $limit $limit_key {
    #     0 "";
    #     1 $binary_remote_addr;
    # }
    # 
    # limit_req_zone $limit_key zone=whitelist:10m rate=10r/s;
    
    # Default location
    location / {
        try_files $uri $uri/ =404;
    }
    
    # MODIFY: Custom error page for rate limit exceeded
    error_page 429 /429.html;
    location = /429.html {
        root /usr/share/nginx/html;
        internal;
    }
}

